<h1><%= @topic.title %></h1>

<div class="devise-form">
  <div class="checkbox-label-wrapper form-table">
    <div class="checkbox-row">
      <input type="checkbox" id="use-timer" />
      <label for="use-timer">Use Timer</label>
    </div>

    <button class="devise-btn" id="play-button">Play</button>
  </div>
</div>

<%# this is where the game will go %>
<div id="game-container" style="display: none !important;" data-user-signed-in="<%= user_signed_in? %>" data-topic-id="<%= @topic.id %>"></div>

<script>
  document.addEventListener("turbo:load", function () {
    <%
      manifest_path = Rails.root.join("public/packs/manifest.json")
      manifest_json = File.exist?(manifest_path) ? File.read(manifest_path) : "{}"
    %>
    window.WEBPACK_MANIFEST = <%= raw manifest_json %>;

    const formWrapper = document.querySelector(".devise-form");
    const playButton = document.getElementById("play-button");
    const useTimerCheckbox = document.getElementById("use-timer");
    const gameContainer = document.getElementById("game-container");
    const gameIndex = <%= @topic.id %>;

    gameContainer.style.display = "none";

    if (!playButton) return; // Prevents error if element doesn't exist

    playButton.addEventListener("click", function (e) {
      e.preventDefault();

      formWrapper.style.display = "none";
      gameContainer.innerHTML = '';
      gameContainer.style.display = "block";

      const existingScript = document.getElementById("dynamic-game-script");
      if (existingScript) existingScript.remove();

      const modeKey = useTimerCheckbox.checked ? 'withTimer' : 'withoutTimer';
      const fileMode = useTimerCheckbox.checked ? 'with_timer' : 'without_timer';

      if (PRELOADED_GAMES[gameIndex] && PRELOADED_GAMES[gameIndex][modeKey]) {
        PRELOADED_GAMES[gameIndex][modeKey](gameContainer);
      } else {
        const logicalName = `topic${gameIndex}_${fileMode}.js`;
        const manifest = window.WEBPACK_MANIFEST;
        const hashedPath = manifest[logicalName];

        if (hashedPath) {
          const script = document.createElement("script");
          script.id = "dynamic-game-script";
          script.type = "text/javascript";
          script.src = hashedPath;
          document.body.appendChild(script);
        } else {
          console.error(`Topic script not found in manifest: ${logicalName}`);
        }
      }
    });
  });
</script>


