<div class="devise-form">
  <h1>Billing</h1>

  <% if current_user.billing_status == "active" %>
    <p>Your subscription is active.</p>
    <p>Plan: <%= current_user.plan_name %></p>

    <% if current_user.subscription_ends_at.present? %>
      <p>Renews on: <%= current_user.subscription_ends_at.to_date %></p>
    <% end %>

    <%= button_to "Manage billing (update card / cancel)",
          portal_payments_path,
          method: :post,
          data: {turbo: false} %>
  <% else %>
    <p>You donâ€™t have an active subscription yet.</p>

    <%= form_with url: payments_path, method: :post, data: { turbo: false } do %>
      <div class="mt-4">
        <label class="inline-flex items-start gap-2">
          <%= check_box_tag :legal_acceptance, "1", false, required: true, class: "mt-1" %>
          <span>
            I agree to the
            <%= link_to "Terms of Service", terms_path, target: "_blank", class: "underline hover:text-blue-600" %>
            and
            <%= link_to "Privacy Policy", privacy_path, target: "_blank", class: "underline hover:text-blue-600" %>.
          </span>
        </label>
      </div>

      <div class="mt-4">
        <%= submit_tag "Start subscription", class: "rounded-lg px-4 py-2 font-semibold bg-black text-white hover:opacity-90" %>
      </div>
    <% end %>
  <% end %>

</div>

<style>
  .card-input {
    background: white;
    border: 1px solid #ccc;
    border-radius: 6px;
    margin-bottom: 15px;
    height: 45px;
    display: flex;
    align-items: center; /* centers iframe */
  }

  .card-errors {
    color: red;
    margin-bottom: 15px;
    font-weight: bold;
  }

  #submit-button {
    display: block;
    font-size: 1.1rem;
    font-weight: bold;
    margin-top: 10px;
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
  var stripe = Stripe("<%= Rails.application.credentials.dig(:stripe, :publishable_key) %>");
  var elements = stripe.elements();

  var style = {
    base: {
      fontSize: '16px',
      color: '#32325d',
      '::placeholder': { color: '#aab7c4' }
    },
    invalid: { color: '#fa755a' }
  };

  var cardNumber = elements.create("cardNumber", { style: style });
  cardNumber.mount("#card-number");

  var cardExpiry = elements.create("cardExpiry", { style: style });
  cardExpiry.mount("#card-expiry");

  var cardCvc = elements.create("cardCvc", { style: style });
  cardCvc.mount("#card-cvc");

  var form = document.getElementById("payment-form");

  form.addEventListener("submit", function(event) {
    event.preventDefault();

    stripe.createPaymentMethod({
      type: 'card',
      card: cardNumber
    }).then(function(result) {
      if (result.error) {
        document.getElementById("card-errors").textContent = result.error.message;
      } else {
        var hiddenInput = document.createElement('input');
        hiddenInput.setAttribute('type', 'hidden');
        hiddenInput.setAttribute('name', 'payment_method');
        hiddenInput.setAttribute('value', result.paymentMethod.id);
        form.appendChild(hiddenInput);

        form.submit();
      }
    });
  });
});
</script>
