<div class="devise-form">
  <h1>Update Payment Method</h1>

  <%= form_with url: payment_method_path, method: :patch, id: "payment-form", local: false do |f| %>
    
    <label>Card Number</label>
    <div id="card-number" class="card-input"></div>

    <label>Expiry Date</label>
    <div id="card-expiry" class="card-input"></div>

    <label>CVC</label>
    <div id="card-cvc" class="card-input"></div>

    <div id="card-errors" role="alert" class="card-errors"></div>

    <%= f.submit "Update Payment", id: "submit-button", class: "btn btn-primary" %>
  <% end %>
</div>

<style>
  .card-input {
    background: white;
    border: 1px solid #ccc;
    border-radius: 6px;
    margin-bottom: 15px;
    height: 45px;
    display: flex;
    align-items: center; /* centers iframe */
  }

  .card-errors {
    color: red;
    margin-bottom: 15px;
    font-weight: bold;
  }

  #submit-button {
    display: block;
    font-size: 1.1rem;
    font-weight: bold;
    margin-top: 10px;
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
  var stripe = Stripe("<%= Rails.application.credentials.dig(:stripe, :publishable_key) %>");
  var elements = stripe.elements();

  var style = {
    base: {
      fontSize: '16px',
      color: '#32325d',
      '::placeholder': { color: '#aab7c4' }
    },
    invalid: { color: '#fa755a' }
  };

  var cardNumber = elements.create("cardNumber", { style: style });
  cardNumber.mount("#card-number");

  var cardExpiry = elements.create("cardExpiry", { style: style });
  cardExpiry.mount("#card-expiry");

  var cardCvc = elements.create("cardCvc", { style: style });
  cardCvc.mount("#card-cvc");

  var form = document.getElementById("payment-form");

  form.addEventListener("submit", function(event) {
    event.preventDefault();

    stripe.createPaymentMethod({
      type: 'card',
      card: cardNumber
    }).then(function(result) {
      if (result.error) {
        document.getElementById("card-errors").textContent = result.error.message;
      } else {
        var hiddenInput = document.createElement('input');
        hiddenInput.setAttribute('type', 'hidden');
        hiddenInput.setAttribute('name', 'payment_method');
        hiddenInput.setAttribute('value', result.paymentMethod.id);
        form.appendChild(hiddenInput);

        form.submit();
      }
    });
  });
});
</script>
